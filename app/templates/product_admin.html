<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>TOC - admin</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="static/assets/img/toc_logo.png" rel="icon">
  <link href="static/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

<!--  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script>


  <!-- Vendor CSS Files -->
  <link href="static/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="static/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="static/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="static/assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="static/assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="static/assets/vendor/remixicon/remixicon.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="static/assets/css/style.css" rel="stylesheet">

  <script src="static/assets/js/functions.js"></script>

<!--    Datatables-->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>




  <!-- =======================================================
  * Template Name: NiceAdmin
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Updated: Apr 20 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

   {% include 'header-bar.html' %}

   {% include 'side-bar.html' %}

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Admin</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item">Pages</li>
          <li class="breadcrumb-item active">Product Admin</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section">
      <div class="row">
        <div class="col-lg-12">

        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Products</h5>
<!--              <div class="d-flex gap-2">-->
<!--                <label for="orderName" class="form-label mb-0">Select Order:</label>-->
<!--                <select id="orderName" class="form-control">-->
<!--                  <option value="" disabled selected>No Order Found</option>-->
<!--                  &lt;!&ndash; Options will be populated dynamically &ndash;&gt;-->
<!--                </select>-->
<!--              </div>-->
<!-- <div class="d-inline-flex align-items-center gap-2">-->
<!--  <label for="orderName" class="form-label mb-0">Select Order:</label>-->
<!--  <select id="orderName" class="form-select">-->
<!--    <option value="" disabled selected>No Order Found</option>-->
<!--    &lt;!&ndash; Options will be populated dynamically &ndash;&gt;-->
<!--  </select>-->
<!--</div>-->

            </div>
            <div class="d-flex gap-1 mt-3">
              <button class="btn btn-primary" id="getUsers" >Get Products</button>
              <button class="btn btn-primary" id="createUser" >Create Product</button>
<!--              <button class="btn btn-primary" id="saveOrder"   disabled >Confirm Stock</button>-->
<!--&lt;!&ndash;              <button class="btn btn-primary" id="submitOrder" data-bs-placement="bottom" data-bs-original-title="Notify order to head quarter" disabled>Submit Order</button>&ndash;&gt;-->
<!--              <button class="btn btn-primary" id="closeOrder"   disabled>Close Form</button>-->
<!--&lt;!&ndash;              <button class="btn btn-danger" id="cancelOrder" data-bs-placement="bottom" data-bs-original-title="Delete current order" disabled>Cancel Order</button>&ndash;&gt;-->
<!--              <button class="btn btn-danger" id="resetQty" data-bs-placement="bottom" data-bs-original-title="Reset all order quantity to zero" disabled>Reset Count</button>-->
            </div>

              <!--Handle the csv file -->

<table id="Users" border="1">
    <thead></thead>
    <tbody></tbody>
</table>


          </div>
        </div>

<!-- Update Product Modal -->
<div class="modal fade" id="updateProductModal" tabindex="-1" aria-labelledby="updateProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateProductModalLabel">Update Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateProductForm">
                    <!-- Disabled item_sku field -->
                    <div class="mb-3">
                        <label for="updateItemSku" class="form-label">Item SKU</label>
                        <input type="text" class="form-control" id="updateItemSku" disabled>
                    </div>
                    <!-- Other editable fields -->
                    <div class="mb-3">
                        <label for="updateItemName" class="form-label">Item Name</label>
                        <input type="text" class="form-control" id="updateItemName" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="updateStatGroup" class="form-label">Stat Group</label>
                        <input type="text" class="form-control" id="updateStatGroup">
                    </div>
                    <div class="mb-3">
                        <label for="updateAcctGroup" class="form-label">Acct Group</label>
                        <input type="text" class="form-control" id="updateAcctGroup">
                    </div>
                    <div class="mb-3">
                        <label for="updateRetailPrice" class="form-label">Retail Price</label>
                        <input type="number" step="0.01" class="form-control" id="updateRetailPrice">
                    </div>
                    <div class="mb-3">
                        <label for="updateCostPrice" class="form-label">Cost Price</label>
                        <input type="number" step="0.01" class="form-control" id="updateCostPrice">
                    </div>
                    <div class="mb-3">
                        <label for="updateWhPrice" class="form-label">Wholesale Price</label>
                        <input type="number" step="0.01" class="form-control" id="updateWhPrice">
                    </div>
                    <div class="mb-3">
                        <label for="updateCannCostPrice" class="form-label">Cann Cost Price</label>
                        <input type="number" step="0.01" class="form-control" id="updateCannCostPrice">
                    </div>
                    <div class="mb-3">
                        <label for="updateProductUrl" class="form-label">Product URL</label>
                        <input type="url" class="form-control" id="updateProductUrl">
                    </div>
                    <div class="mb-3">
                        <label for="updateImageUrl" class="form-label">Image URL</label>
                        <input type="url" class="form-control" id="updateImageUrl">
                    </div>
<div class="mb-3">
    <label for="updateStockOrdInd" class="form-label">Stock Order Indicator</label>
    <select class="form-select" id="updateStockOrdInd">
        <option value="1">Physical item</option>
        <option value="0">Special package</option>
    </select>
</div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveUpdatedProduct">Update</button>
            </div>
        </div>
    </div>
</div>



<!-- Bootstrap Modal -->
<div class="modal fade" id="createProductModal" tabindex="-1" aria-labelledby="createProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createProductModalLabel">Create New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Form for product details -->
        <form id="createProductForm">
          <div class="mb-3">
            <label for="item_sku" class="form-label">Item SKU</label>
            <input type="text" class="form-control" id="item_sku" required>
          </div>
          <div class="mb-3">
            <label for="item_name" class="form-label">Item Name</label>
            <input type="text" class="form-control" id="item_name" required>
          </div>
          <div class="mb-3">
            <label for="stat_group" class="form-label">Stat Group</label>
            <input type="text" class="form-control" id="stat_group">
          </div>
          <div class="mb-3">
            <label for="acct_group" class="form-label">Account Group</label>
            <input type="text" class="form-control" id="acct_group">
          </div>
          <div class="mb-3">
            <label for="retail_price" class="form-label">Retail Price</label>
            <input type="number" class="form-control" id="retail_price">
          </div>
          <div class="mb-3">
            <label for="cost_price" class="form-label">Cost Price</label>
            <input type="number" class="form-control" id="cost_price">
          </div>
          <div class="mb-3">
            <label for="wh_price" class="form-label">Wholesale Price</label>
            <input type="number" class="form-control" id="wh_price">
          </div>
          <div class="mb-3">
            <label for="cann_cost_price" class="form-label">Cannabis Cost Price</label>
            <input type="number" class="form-control" id="cann_cost_price">
          </div>
          <div class="mb-3">
            <label for="product_url" class="form-label">Product URL</label>
            <input type="url" class="form-control" id="product_url">
          </div>
          <div class="mb-3">
            <label for="image_url" class="form-label">Image URL</label>
            <input type="url" class="form-control" id="image_url">
          </div>
<div class="mb-3">
    <label for="updateStockOrdInda" class="form-label">Stock Order Indicator</label>
    <select class="form-select" id="updateStockOrdInda">
        <option value="1">Physical item</option>
        <option value="0">Special package</option>
    </select>
</div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="submitCreateProduct" class="btn btn-primary">Create</button>
      </div>
    </div>
  </div>
</div>


<script>

    var _t_order_product_template;
    var _saved = false;
    var productDataList = [];


 $(document).ready(async function() {

    var shops = {{ shops | tojson }};
    console.log("List of shops:", shops);
    shops.push("Head Office");

    var roles = {{ roles | tojson }};
    var user_role = "{{user.role}}";
    console.log("roles:", roles);
    const list_of_roles = roles.map(item => item.role);
    console.log(list_of_roles);


    disableControlsPerRole(roles,user_role);


$("#getUsers").on("click", function (event) {
    event.preventDefault();

    // Fetch user data via AJAX
    $.ajax({
        url: "/api/products",
        method: "GET",
        success: function (response) {
            // Store the fetched product data in a global variable
            productDataList = response;

            // Destroy existing DataTable if it exists
            if ($.fn.DataTable.isDataTable("#Users")) {
                $('#Users').DataTable().destroy();
            }

            // Clear the table body and headers
            $('#Users tbody').empty();
            $('#Users thead').empty();

            // Define the correct column order
            const columnOrder = [
                "item_sku", "item_name", "stat_group", "acct_group", "retail_price",
                "cost_price", "wh_price", "cann_cost_price", "product_url", "image_url", "stock_ord_ind"
            ];

            // Generate table header
            let headerHtml = '<tr>';
            columnOrder.forEach(function (header) {
                headerHtml += `<th>${header.charAt(0).toUpperCase() + header.slice(1)}</th>`;
            });
            headerHtml += '<th>Actions</th>'; // Add Actions column for Update/Delete
            headerHtml += '</tr>';
            $('#Users thead').append(headerHtml);

            // Populate the table with data
            const tableData = response.map(product => {
                let rowData = [];
                columnOrder.forEach(function (header) {
                    rowData.push(product[header]);
                });

                rowData.push(`
                    <button class="btn btn-primary btn-update"
                            data-id="${product.item_sku}">Update</button>
                    <button class="btn btn-danger btn-delete"
                            data-id="${product.item_sku}">Delete</button>
                `);
                return rowData;
            });

            // Initialize the DataTable with custom column widths
            $('#Users').DataTable({
                data: tableData,
                paging: true,
                searching: true,
                ordering: true,
                columnDefs: [
                    {
                        targets: [8, 9],  // Indices of the product_url and image_url columns
                        width: '200px',  // Set the width for both columns (increase if needed)
                        className: 'text-center',  // Optional: center the content
                    },
                    {
                        targets: 10,  // The Actions column
                        width: '200px',  // Ensure enough width for the buttons
                        className: 'text-center',  // Optional: center the buttons
                    }
                ]
            });
        },
        error: function (xhr, status, error) {
            console.error("Error fetching users:", error);
            alert("Failed to load users.");
        }
    });
});



// Add event listener for the Delete button inside the DataTable
$('#Users').on('click', '.btn-delete', function () {
    const productId = $(this).data('id'); // Get the product ID from the button's data-id attribute

    // Show a confirmation dialog
    if (confirm(`Are you sure you want to delete product with ID ${productId}?`)) {
        // If confirmed, send a DELETE request to the server
        $.ajax({
            url: `/api/products/${productId}`, // Endpoint to delete the product
            method: "DELETE",
            success: function () {
                alert(`Product ID ${productId} deleted successfully.`); // Notify success
                $('#getUsers').trigger('click'); // Refresh the table by re-triggering the "Get Products" action
            },
            error: function (xhr, status, error) {
                console.error(`Failed to delete product ID ${productId}:`, error);
                alert('Failed to delete the product.'); // Notify failure
            }
        });
    } else {
        // If the user cancels the action, do nothing
        console.log(`Deletion for product ${productId} was canceled.`);
    }
});


    // Open modal when clicking the "Create Product" button
    $("#createUser").on("click", function () {
        $("#createProductModal").modal("show");
    });

    // Handle form submission when clicking "Create" in the modal
    $("#submitCreateProduct").on("click", function () {
        // Collect form data
        const productData = {
            item_sku: $("#item_sku").val(),
            item_name: $("#item_name").val(),
            stat_group: $("#stat_group").val(),
            acct_group: $("#acct_group").val(),
            retail_price: $("#retail_price").val(),
            cost_price: $("#cost_price").val(),
            wh_price: $("#wh_price").val(),
            cann_cost_price: $("#cann_cost_price").val(),
            product_url: $("#product_url").val(),
            image_url: $("#image_url").val(),
            stock_ord_ind: $("#stock_ord_ind").val(),
        };

        // Validate required fields
        if (!productData.item_sku || !productData.item_name) {
            alert("Item SKU and Item Name are required.");
            return;
        }

        // Send AJAX POST request to Flask route
        $.ajax({
            url: "/api/products",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(productData),
            success: function (response) {
                alert("Product created successfully!");
                // Close the modal
                $("#createProductModal").modal("hide");
                // Optionally reload the products table
                $("#getUsers").click(); // Trigger fetching updated products list
            },
            error: function (xhr, status, error) {
                alert("Failed to create product: " + xhr.responseText);
            },
        });
    });


// Attach click event listener for Update button
$('#Users').on('click', '.btn-update', function () {
    const productId = $(this).data('id');

    // Find the product data in the global variable
    const productData = productDataList.find(product => product.item_sku == productId);

    if (productData) {
        // Populate modal fields with product data
        $('#updateItemSku').val(productData.item_sku);
        $('#updateItemName').val(productData.item_name);
        $('#updateStatGroup').val(productData.stat_group);
        $('#updateAcctGroup').val(productData.acct_group);
        $('#updateRetailPrice').val(productData.retail_price);
        $('#updateCostPrice').val(productData.cost_price);
        $('#updateWhPrice').val(productData.wh_price);
        $('#updateCannCostPrice').val(productData.cann_cost_price);
        $('#updateProductUrl').val(productData.product_url);
        $('#updateImageUrl').val(productData.image_url);
        $('#updateStockOrdInd').val(productData.stock_ord_ind);

        // Show the modal
        $('#updateProductModal').modal('show');
    } else {
        alert('Product data not found.');
    }
});

// Handle Save Update Button click
$('#saveUpdatedProduct').on('click', function () {
    const updatedProduct = {
        item_sku: $('#updateItemSku').val(), // Disabled, but still send for reference
        item_name: $('#updateItemName').val(),
        stat_group: $('#updateStatGroup').val(),
        acct_group: $('#updateAcctGroup').val(),
        retail_price: parseFloat($('#updateRetailPrice').val()),
        cost_price: parseFloat($('#updateCostPrice').val()),
        wh_price: parseFloat($('#updateWhPrice').val()),
        cann_cost_price: parseFloat($('#updateCannCostPrice').val()),
        product_url: $('#updateProductUrl').val(),
        image_url: $('#updateImageUrl').val(),
        stock_ord_ind: parseInt($('#updateStockOrdInd').val(), 10)
    };

    // Send AJAX PUT request to update product
    $.ajax({
        url: `/api/products/${updatedProduct.item_sku}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(updatedProduct),
        success: function (response) {
            alert('Product updated successfully.');
            $('#updateProductModal').modal('hide'); // Close the modal
            $('#getUsers').trigger('click'); // Refresh the table
        },
        error: function (xhr, status, error) {
            console.error('Failed to update product:', error);
            alert('Failed to update the product.');
        }
    });
});



 });
  //////// EVENTS //////////



    //log activity
    $(".btn").on("click", function () {
        // Get the text of the clicked button
        const buttonText = $(this).text().trim();

        // Get the current file name without the ".html" postfix
        const fileName = window.location.pathname.split("/").pop().replace(".html", "");

        // Create a combined activity description
        const activityDescription = `${fileName}: ${buttonText}`;

        // Call the logUserActivity function with the combined description
        logUserActivity(activityDescription);
    });



    </script>


            </div>
          </div>

        </div>

<!--        <div class="col-lg-6">-->

<!--          <div class="card">-->
<!--            <div class="card-body">-->
<!--              <h5 class="card-title">Example Card</h5>-->
<!--              <p>This is an examle page with no contrnt. You can use it as a starter for your custom pages.</p>-->
<!--            </div>-->
<!--          </div>-->

<!--        </div>-->
      </div>
    </section>
  </main><!-- End #main -->


    <script src="https://bootstrapmade.com/demo/NiceAdmin/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>



  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>NiceAdmin</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
      <!-- All the links in the footer should remain intact. -->
      <!-- You can delete the links only if you purchased the pro version. -->
      <!-- Licensing information: https://bootstrapmade.com/license/ -->
      <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
      Designed by <a href="http://algo-tt.co.za/">algo-tt</a>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="static/assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="static/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="static/assets/vendor/chart.js/chart.umd.js"></script>
  <script src="static/assets/vendor/echarts/echarts.min.js"></script>
  <script src="static/assets/vendor/quill/quill.js"></script>
  <script src="static/assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="static/assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="static/assets/js/main.js"></script>



</body>

</html>