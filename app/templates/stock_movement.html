<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>TOC - Stock Movement</title>
  <link href="static/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="static/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="static/assets/css/style.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
</head>
<body>

{% include 'header-bar.html' %}
{% include 'side-bar.html' %}

<main id="main" class="main">

<div class="pagetitle">
  <h1>Inventory Reports</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item">Inventory</li>
      <li class="breadcrumb-item active">Stock Movement</li>
    </ol>
  </nav>
</div>

<section class="section">
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Stock Movement</h5>

      <form id="stockMovementForm" class="row g-3">
        <!-- Shop -->
        <div class="col-md-3">
          <label for="shop" class="form-label">Shop</label>
          <select id="shop" name="shop" class="form-select">
            {% for s in shops %}
              <option value="{{ s.customer }}" {% if s.customer == shop["customer"] %}selected{% endif %}>
                {{ s.blName }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Items -->
            <div class="col-md-9">
              <label class="form-label">Select Items</label>
              <div style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:5px;">
                <table id="itemsTable" class="table table-sm">
                  <thead>
                    <tr><th></th><th>SKU</th><th>Item Name</th></tr>
                  </thead>
                  <tbody>
                    {% for item in items %}
                    <tr>
                      <td><input type="checkbox" name="items" value="{{ item.item_sku }}"></td>
                      <td>{{ item.item_sku }}</td>
                      <td>{{ item.item_name }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>


        <!-- Date range -->
        <div class="col-md-12">
          <label class="form-label">Search Between Dates</label>
          <div class="row g-2">
            <div class="col-auto">
              <div class="input-group">
                <span class="input-group-text">From</span>
                <input type="text" id="fromDate" class="form-control datepicker" readonly>
              </div>
            </div>
            <div class="col-auto">
              <div class="input-group">
                <span class="input-group-text">To</span>
                <input type="text" id="toDate" class="form-control datepicker" readonly>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <button type="button" id="runReport" class="btn btn-primary mt-3">Run Report</button>
        </div>
      </form>

      <table id="stock_movement_table" class="table table-bordered table-striped w-100 mt-4">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

</main>

<script>
$(document).ready(function () {
  // Datepicker setup
  $('.datepicker').datepicker({
    format: 'yyyy-mm-dd',
    autoclose: true,
    todayHighlight: true
  });
  const today = new Date();
  const lastMonth = new Date();
  lastMonth.setMonth(today.getMonth() - 1);
  $('#fromDate').datepicker('update', lastMonth.toISOString().slice(0,10));
  $('#toDate').datepicker('update', today.toISOString().slice(0,10));

  // âœ… Initialize items table
  $("#itemsTable").DataTable({
    paging: false,
    info: false,
    searching: true,
    order: [[2, "asc"]]   // sort by item_name ascending
  });

  // Run Report
  $("#runReport").on("click", function () {
    const shop = $("#shop").val();
    const fromDate = $("#fromDate").val();
    const toDate = $("#toDate").val();
    let items = [];
    $("input[name='items']:checked").each(function() {
      items.push($(this).val());
    });

    if (!shop || items.length === 0 || !fromDate || !toDate) {
      alert("Please select shop, items and date range.");
      return;
    }

    $.ajax({
      url: "/get_stock_movement",
      method: "GET",
      data: { shop: shop, items: items.join(","), fromDate: fromDate, toDate: toDate },
      success: function (response) {
        if (response.columns && response.data) {
          if ($.fn.DataTable.isDataTable("#stock_movement_table")) {
            $("#stock_movement_table").DataTable().clear().destroy();
          }
          $("#stock_movement_table").DataTable({
            data: response.data,
            columns: response.columns.map(col => ({
              title: col.title,
              data: col.title
            })),
            dom: "Bfrtip",
            buttons: [{ extend: "excel", text: "Download Excel" }],
            pageLength: 50,
            lengthMenu: [[50, 100, 200], [50, 100, 200]],
            fixedHeader: true,
            order: [
              [3, "asc"],   // 4th column ascending (sku)
              [0, "desc"]   // 1st column descending (id)
            ]
          });
        } else {
          alert("No data available.");
        }
      },
      error: function () {
        alert("Error fetching data.");
      }
    });
  });
});
</script>


</body>
</html>
