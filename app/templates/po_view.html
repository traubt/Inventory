<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Purchase Order</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- BOOTSTRAP 5 BUNDLE (Correct modal, no old version) -->
  <link href="/static/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <script src="/static/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <link href="/static/assets/css/style.css" rel="stylesheet">

  <style>
    @media print {
      .d-print-none { display: none !important; }
    }
  </style>
</head>

<body>

{% include 'header-bar.html' %}
{% include 'side-bar.html' %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Purchase Order</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/purchase_orders">Orders</a></li>
        <li class="breadcrumb-item active">View PO</li>
      </ol>
    </nav>
  </div>

<script>
  console.log("DEBUG: shops passed to po_view");

  {% for s in shops %}
    console.log("Shop:", {
      blName: "{{ s.blName }}",
      mt_shop_name: "{{ s.mt_shop_name }}",
      address: "{{ s.address }}",
      vat_no: "{{ s.vat_no }}"
    });
  {% endfor %}
</script>


{# ===============================
   Resolve selected company (ROBUST)
   =============================== #}

{% set company_choice = request.args.get('company', 'holdings') %}

{% if company_choice == 'foods' %}

  {% set company_display_name = 'Canna Foods' %}

  {# Head Office = Canna Foods #}
  {% set company_shop = (
      shops
      | selectattr('blName', 'equalto', 'Head Office')
      | list
      | first
  ) %}

{% else %}

  {% set company_display_name = 'Canna Holdings' %}

  {% set company_shop = (
      shops
      | selectattr('blName', 'equalto', 'Canna Holdings')
      | list
      | first
  ) %}

{% endif %}







  <!-- PRINT AREA -->
  <section class="section bg-white p-4 shadow-sm rounded" id="poPrintArea">

    <!-- HEADER -->
  <div class="d-flex justify-content-between mb-4">

  <div>
    <!-- Company selector -->
    <form method="get" class="mb-2 d-print-none">
      <select name="company"
              class="form-select form-select-sm w-auto"
              onchange="this.form.submit()">
        <option value="holdings" {% if company_choice == 'holdings' %}selected{% endif %}>
          Canna Holdings
        </option>
        <option value="foods" {% if company_choice == 'foods' %}selected{% endif %}>
          Canna Foods
        </option>
      </select>
    </form>

    <!-- Company details -->
    <h3 class="mb-1">
      <strong>{{ company_display_name }}</strong>
    </h3>

    {% if company_shop %}
      {% if company_shop.address %}
        <p class="mb-0">{{ company_shop.address }}</p>
      {% endif %}

      {% if company_shop.vat_no %}
        <p class="mb-0">VAT No: {{ company_shop.vat_no }}</p>
      {% endif %}
    {% endif %}



    <br>
    <p class="mb-0"><strong>Status:</strong> {{ po.status }}</p>
  </div>

  <div class="text-end">
    <h4>PURCHASE ORDER</h4>
    <p><strong>Date:</strong> {{ po.order_date.strftime('%d-%m-%Y') }}</p>
    <p><strong>PO Number:</strong> {{ po.po_number }}</p>
  </div>

</div>




    <!-- SUPPLIER INFO -->
    <div class="mb-3">
      <h5 class="bg-dark text-white p-2">Supplier Information</h5>
      <p><strong>Vendor Name:</strong> {{ po.supplier.name }}</p>
      <p><strong>Contact Email:</strong> {{ po.supplier.email or 'N/A' }}</p>
    </div>

    <!-- TABLE -->
    <div class="table-responsive">
      <table class="table table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>SKU</th>
            <th>Barcode</th>
            <th>Description</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>VAT</th>
            <th>Total</th>
          </tr>
        </thead>

        <tbody>
        {% set total_vat = namespace(val=Decimal('0.00')) %}

        {% for item in items %}
          {% set qty = Decimal(item.quantity_ordered) %}
          {% set unit_price = Decimal(item.unit_price) %}
          {% set line_total = qty * unit_price %}

          {% set vat = (line_total * Decimal('0.15'))
              if item.vat_exempt_ind != 1 and po.supplier.vat_registered
              else Decimal('0.00') %}

          {% set total_vat.val = total_vat.val + vat %}


          <tr>
            <td>{{ item.sku }}</td>
            <td>{{ item.barcode }}</td>
            <td>{{ item.item_name }}</td>
            <td>{{ item.quantity_ordered }}</td>
            <td>{{ '%.2f' % item.unit_price }}</td>
            <td>{{ '%.2f' % vat }}</td>
            <td>{{ '%.2f' % line_total }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- TOTALS -->
    <div class="row my-4">
      <div class="col-md-6">
        <h6 class="bg-dark text-white p-2">Additional Notes:</h6>
        <p class="border p-2">{{ po.notes or 'None' }}</p>
      </div>

      <div class="col-md-6">

        <div class="row justify-content-end">
          <label class="col-sm-4 col-form-label text-end">VAT (15%):</label>
          <div class="col-sm-4 text-end">{{ "%.2f"|format(total_vat.val) }}</div>
        </div>

        <div class="row justify-content-end mt-1">
          <label class="col-sm-4 col-form-label text-end">Grand Total:</label>
          {% set subtotal = po.subtotal or 0 %}
          {% set grand_total = subtotal + total_vat.val %}
          <div class="col-sm-4 text-end"><strong>{{ "%.2f"|format(grand_total) }}</strong></div>
        </div>

      </div>
    </div>

  </section>


<!-- COST OF SALE MODAL -->
<div class="modal fade" id="costOfSaleModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Cost of Sale & Gross Margin</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        {% set total_cost = namespace(val=0) %}
        {% set total_sale = namespace(val=0) %}
        {% set total_qty = namespace(val=0) %}

        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr>
              <th>Description</th>
              <th>Qty</th>
              <th>Sale Price</th>
              <th>Cost Price</th>
              <th>Total Sale</th>
              <th>Total Cost</th>
              <th>Gross Margin</th>
              <th>Gross %</th>
            </tr>
          </thead>

        <tbody>
        {% for item in items %}
          {# Ensure Decimal arithmetic #}
          {% set qty = item.quantity_ordered %}
          {% set sale_p = Decimal(item.retail_price/1.15 or 0) %}
          {% set cost_p = Decimal(item.cost_price or 0) %}
          {% set sale_t = sale_p * qty %}
          {% set cost_t = cost_p * qty %}
          {% set margin = sale_t - cost_t %}
          {% set pct = (margin / sale_t * 100) if sale_t > 0 else 0 %}

          {% set total_qty.val = total_qty.val + qty %}
          {% set total_sale.val = total_sale.val + sale_t %}
          {% set total_cost.val = total_cost.val + cost_t %}

          <tr>
            <td>{{ item.item_name }}</td>
            <td>{{ qty }}</td>
            <td>{{ "%.2f"|format(sale_p) }}</td>
            <td>{{ "%.2f"|format(cost_p) }}</td>
            <td>{{ "%.2f"|format(sale_t) }}</td>
            <td>{{ "%.2f"|format(cost_t) }}</td>
            <td>{{ "%.2f"|format(margin) }}</td>
            <td>{{ "%.1f"|format(pct) }}%</td>
          </tr>
        {% endfor %}
        </tbody>


<tfoot class="table-light">
  <tr>
    <th>Total</th>
    <th>{{ total_qty.val }}</th>
    <th colspan="2"></th>
    <th>{{ "%.2f"|format(total_sale.val) }}</th>
    <th>{{ "%.2f"|format(total_cost.val) }}</th>
    <th>{{ "%.2f"|format(total_sale.val - total_cost.val) }}</th>
    <th>
      {% set tot_pct = ((total_sale.val - total_cost.val) / total_sale.val * 100) if total_sale.val > 0 else 0 %}
      {{ "%.1f"|format(tot_pct) }}%
    </th>
  </tr>
</tfoot>

        </table>

      </div>
    </div>
  </div>
</div>



<!-- ACTION BUTTONS -->
<div class="text-end mt-4 d-print-none">

  <a href="{{ url_for('main.purchase_orders') }}" class="btn btn-secondary">Back</a>

  <a class="btn btn-outline-primary"
     href="{{ url_for('main.po_edit', po_id=po.id) }}"
     {% if po.status != 'Draft' %}disabled{% endif %}>
     Edit
  </a>

  <button class="btn btn-outline-primary" onclick="printPDF()">Download</button>

  <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#costOfSaleModal">
    Cost of Sale
  </button>

  <button id="approve-btn"
          class="btn btn-success"
          {% if po.status != 'Draft' %}disabled{% endif %}>
          Approve
  </button>

  <button class="btn btn-primary" id="sendToSupplierBtn">Send to Supplier</button>

</div>


<script>


// APPROVE BUTTON
$("#approve-btn").click(function () {
    if (!confirm("Approve this Purchase Order?")) return;
    window.location.href = "/purchase_orders/{{ po.id }}/approve";
});

// SEND EMAIL
document.getElementById("sendToSupplierBtn").onclick = function () {

    const to = "{{ po.supplier.email or '' }}";
    const subject = "Purchase Order {{ po.po_number }}";

    let body = "";

    body += "Dear {{ po.supplier.name }},\n\n";
    body += "Please find below the details of our Purchase Order:\n";
    body += "PO Number: {{ po.po_number }}\n";
    body += "PO Date: {{ po.order_date.strftime('%d-%m-%Y') }}\n\n";
    body += "Items Ordered:\n";
    body += "----------------------------------------\n";
    body += "SKU | Description | Qty | Unit | Total\n";
    body += "----------------------------------------\n";

    {% for item in items %}
    body += "{{ item.sku }} | {{ item.item_name }} | {{ item.quantity_ordered }} | {{ '%.2f'|format(item.unit_price) }} | {{ '%.2f'|format(item.unit_price * item.quantity_ordered) }}\n";
    {% endfor %}

    body += "----------------------------------------\n";
    body += "Grand Total: {{ '%.2f'|format(grand_total) }}\n\n";
    body += "Kind regards,\nTaste Of Cannabis Purchasing Team";

    window.location.href =
        "mailto:" + encodeURIComponent(to) +
        "?subject=" + encodeURIComponent(subject) +
        "&body=" + encodeURIComponent(body);
};


// PRINT PDF
function printPDF() {
    const content = document.getElementById("poPrintArea").outerHTML;

    const win = window.open("", "", "width=1100,height=900");
    win.document.write(`
        <html>
        <head>
            <link rel="stylesheet" href="/static/assets/vendor/bootstrap/css/bootstrap.min.css">
        </head>
        <body>${content}</body>
        </html>
    `);
    win.document.close();
    setTimeout(() => win.print(), 300);
}

</script>

</body>
</html>
