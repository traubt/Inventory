<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Purchase Orders</title>

  <!-- Favicons -->
  <link href="/static/assets/img/best_before.png" rel="icon">
  <link href="/static/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700|Nunito:300,400,600,700|Poppins:300,400,500,600,700" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="/static/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="/static/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="/static/assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="/static/assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="/static/assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Vendor JS Files -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/static/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/static/assets/vendor/quill/quill.js"></script>
  <script src="/static/assets/vendor/simple-datatables/simple-datatables.js"></script>
  <script src="/static/assets/js/functions.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>



  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Your existing DataTable init -->


  <!-- Main CSS File -->
  <link href="/static/assets/css/style.css" rel="stylesheet">
</head>

<body>


{% include 'header-bar.html' %}
{% include 'side-bar.html' %}


<main id="main" class="main">
<div class="pagetitle">
  <h1>Receive Goods for PO: {{ po.po_number }}</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('main.receive_goods') }}">Receive Goods</a></li>
      <li class="breadcrumb-item active">PO {{ po.po_number }}</li>
    </ol>
  </nav>
</div>

<section class="section">

<!-- Invoice Upload Form -->
<!--<form id="upload-invoice-form" enctype="multipart/form-data" class="mb-4">-->
<!--  <div class="input-group">-->
<!--    <input type="file" id="invoice_file" name="invoice_file" accept="application/pdf" class="form-control" required>-->
<!--    <button class="btn btn-outline-secondary" type="button" id="uploadInvoiceBtn">Upload Invoice</button>-->
<!--  </div>-->
<!--</form>-->

  <form id="grv-form" method="POST" action="{{ url_for('main.submit_grv', po_id=po.id) }}">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Supplier: {{ po.supplier_name }}</h5>

<div class="row mb-2 justify-content-start">
  <div class="col-md-3">
    <label for="invoice_number" class="form-label">Invoice Number:</label>
    <input type="text" id="invoice_number" name="invoice_number" class="form-control"
           value="{{ grv.invoice_number if grv else '' }}" required>
  </div>

  <div class="col-md-3">
    <label for="invoice_date" class="form-label">Invoice Date:</label>
    <input type="date" id="invoice_date" name="invoice_date" class="form-control"
           value="{{ grv.invoice_date if grv and grv.invoice_date else '' }}" required>
  </div>

  <div class="col-md-3">
    <label class="form-label">GRV Status:</label>
    <input type="text" id="grv_status_display" class="form-control" value="{{ grv.status if grv else 'Draft' }}" readonly>
  </div>

  <div class="col-md-3">
    <label class="form-label">Last Update:</label>
    <input type="text" class="form-control" value="{{ grv.update_date if grv and grv.update_date else '' }}" readonly>
  </div>
</div>


<hr>

  <div class="table-responsive">
   <table id="poTable" class="table table-bordered text-center" style="width: 100%;">
  <thead class="table-light">
    <tr>
      <th>SKU</th>
      <th>Description</th>
      <th>Cost Price</th>
      <th>Ordered Qty</th>
      <th>PO VAT</th>
      <th>PO Amount</th>
      <th>Qty Received</th>
      <th>Damaged Qty</th>
      <th>Invoice Item Cost</th>
      <th>Invoice Qty</th>
      <th>Invoice VAT</th>
      <th>Invoice Amount</th>

    </tr>
  </thead>
<tbody>
{% set grv_status = grv.status if grv else 'Draft' %}

{% for item in items %}
    {# Lookup matching GRV row by PO item id #}
    {% set gi = grv_items_dict.get(item.id) %}
    {% set fully_received = grv_status == 'Completed' %}

    {% set discrepancy_class = '' %}
    {% if gi and (gi.damaged_quantity > 0 or (gi.quantity_received or 0) < item.quantity_ordered) %}
        {% set discrepancy_class = 'table-warning' %}
    {% endif %}

    <tr class="{{ discrepancy_class }}">
        <td>{{ item.sku }}</td>
        <td>{{ item.item_name }}</td>
        <td>{{ item.cost_price }}</td>
        <td>{{ item.quantity_ordered }}</td>
        <td>{{ item.tax_amount }}</td>
        <td>{{ item.total_amount }}</td>

        <!-- Qty Received -->
        <td>
            <input type="number"
                   name="received_{{ item.id }}"
                   class="form-control"
                   min="0"
                   max="{{ item.quantity_ordered }}"
                   value="{{ gi.quantity_received if gi else item.quantity_ordered }}"
                   {% if fully_received %}readonly{% endif %}
                   required>
        </td>

        <!-- Damaged Qty -->
        <td>
            <input type="number"
                   name="damaged_{{ item.id }}"
                   class="form-control"
                   min="0"
                   max="{{ item.quantity_ordered }}"
                   value="{{ gi.damaged_quantity if gi else '' }}"
                   {% if fully_received %}readonly disabled{% endif %}>
        </td>

        <!-- Invoice Item Cost -->
        <td>
          <input type="number"
                 name="invoice_cost_{{ item.id }}"
                 class="form-control invoice-cost"
                 step="0.0001"
                 value="{{
                      ((gi.invoice_amount|float) / (gi.invoice_quantity|float))
                      if gi and (gi.invoice_quantity|float) > 0
                      else (item.cost_price|float)
                    }}"
                    >
        </td>


        <!-- Invoice Qty -->
        <td>
          <input type="number"
                 name="invoice_qty_{{ item.id }}"
                 class="form-control"
                 step="0.01"
                 value="{{ gi.invoice_quantity if gi else item.quantity_ordered }}">
        </td>

        <!-- Invoice VAT -->
        <td>
            <input type="number"
                   name="invoice_vat_{{ item.id }}"
                   class="form-control"
                   step="0.01"
                   value="{{ gi.invoice_vat if gi else '' }}">
        </td>

        <!-- Invoice Amount -->
        <td>
            <input type="number"
                   name="invoice_total_{{ item.id }}"
                   class="form-control bg-light"
                   step="0.01"
                   value="{{ gi.invoice_amount if gi else '' }}"
                   readonly>
        </td>
    </tr>
{% endfor %}
</tbody>



</table>
  </div>

<div class="d-flex justify-content-end mt-4">
  <div style="width: 450px;">
    <div class="d-flex align-items-center mb-2">
      <label for="po_vat_total" class="form-label mb-0 me-2" style="min-width: 170px;"><strong>PO VAT Amount</strong></label>
      <input type="text" class="form-control" id="po_vat_total" name="po_vat_total"
             value="{{ '%.2f' % items | map(attribute='tax_amount') | sum if items else '0.00' }}"
             readonly>
    </div>

    <div class="d-flex align-items-center mb-2">
      <label for="po_total" class="form-label mb-0 me-2" style="min-width: 170px;"><strong>PO Total</strong></label>
      <input type="text" class="form-control" id="po_total" name="po_total"
             value="{{ '%.2f' % items | map(attribute='total_amount') | sum if items else '0.00' }}"
             readonly>
    </div>

    <div class="d-flex align-items-center mb-2">
      <label for="inv_vat" class="form-label mb-0 me-2" style="min-width: 170px;"><strong>Invoice VAT Amount</strong></label>
      <input type="number" step="0.01" class="form-control" id="inv_vat" name="inv_vat"
       value="{{ grv.invoice_vat_total if grv and grv.invoice_vat_total is not none else '' }}" readonly>

    </div>

    <div class="d-flex align-items-center mb-2">
      <label for="inv_total" class="form-label mb-0 me-2" style="min-width: 170px;"><strong>Invoice Total</strong></label>
<input type="number" step="0.01" class="form-control" id="inv_total" name="inv_total"
       value="{{ grv.invoice_total_amount if grv and grv.invoice_total_amount is not none else '' }}" readonly>
    </div>

    <hr class="my-2">

    <div class="d-flex align-items-center">
      <label for="diff" class="form-label mb-0 me-2" style="min-width: 170px;"><strong>Difference</strong></label>
<input type="number" step="0.01" class="form-control" id="diff" name="difference"
       value="{{ grv.diff_amount if grv and grv.diff_amount is not none else '' }}" readonly>
    </div>
  </div>
</div>


        <div class="mb-3">
          <label for="grv_note" class="form-label">Notes</label>
          <textarea class="form-control" id="grv_note" name="note" rows="3"></textarea>
        </div>

        <button type="submit" class="btn btn-success">Save GRV</button>
        <a href="{{ url_for('main.receive_goods') }}" class="btn btn-secondary">Cancel</a>
        <button type="button" class="btn btn-primary ms-2" id="confirm-grv-btn">Confirm GRV</button>
<!--        <button type="button" class="btn btn-warning ms-2" id="create-debit-note-btn">Create Debit Note</button>-->
      </div>
    </div>
  </form>

</section>
</main>

<script>

let grvConfirmedWithCostUpdates = false;

$(document).ready(function () {

    $("#modalOkBtn").on("click", function () {

        if (grvConfirmedWithCostUpdates) {

            const successModal = new bootstrap.Modal(
                document.getElementById("grvConfirmSuccessModal")
            );

            successModal.show();

            grvConfirmedWithCostUpdates = false; // reset
        }
    });


    // Mark preloaded invoice amounts as user-set so JS won't override them
    $("input[name^='invoice_total_']").each(function () {
        if ($(this).val().trim() !== "") {
            $(this).data("user-set", true);
        }
    });

    // Debug
    console.log("Loaded invoice totals:");
    $("input[name^='invoice_total_']").each(function () {
        console.log($(this).attr("name"), "=", $(this).val());
    });

    // -----------------------------
    //  DataTable
    // -----------------------------
    let table = $('#poTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excelHtml5',
                text: 'Download Excel',
                title: 'PO_List_' + new Date().toISOString().slice(0, 10)
            }
        ],
        paging: false,
        searching: true,
        info: false,
        order: [[0, 'desc']]
    });

    // -----------------------------
    //  Detect manual field overrides
    // -----------------------------

    // Invoice VAT manually overridden?
    $(document).on("input", "input[name^='invoice_vat_']", function () {
        $(this).data("user-set", true);
        updateInvoiceTotals();
    });

    // Invoice Amount manually overridden?
    $(document).on("input", "input[name^='invoice_total_']", function () {
        $(this).data("user-set", true);
        updateInvoiceTotals();
    });

    $(document).on("input", "input[name^='invoice_cost_']", function () {
        updateInvoiceTotals();
    });


    // -----------------------------
    //  Update row values
    // -----------------------------
    function updateRow(row) {

        const qty = parseFloat(row.find("input[name^='invoice_qty_']").val()) || 0;
        const itemCost = parseFloat(row.find("input[name^='invoice_cost_']").val()) || 0;

        const poVat = parseFloat(row.find("td:eq(4)").text().trim()) || 0;
        const poAmount = parseFloat(row.find("td:eq(5)").text().trim()) || 0;

        const invoiceAmount = qty * itemCost;

        // Set calculated invoice amount
        row.find("input[name^='invoice_total_']")
           .val(invoiceAmount.toFixed(2));

        // VAT auto-calc unless overridden
        const vatField = row.find("input[name^='invoice_vat_']");
        if (!vatField.data("user-set")) {
            const vatRate = poAmount > 0 ? (poVat / poAmount) : 0;
            vatField.val((invoiceAmount * vatRate).toFixed(2));
        }
    }


    // -----------------------------
    //  Update totals
    // -----------------------------
    function updateInvoiceTotals() {

        let totalInv = 0;
        let totalInvVat = 0;

        $("#poTable tbody tr").each(function () {
            const row = $(this);
            updateRow(row);

            totalInv += parseFloat(row.find("input[name^='invoice_total_']").val()) || 0;
            totalInvVat += parseFloat(row.find("input[name^='invoice_vat_']").val()) || 0;
        });

        $("#inv_total").val(totalInv.toFixed(2));
        $("#inv_vat").val(totalInvVat.toFixed(2));

        const poTotal = parseFloat($("#po_total").val()) || 0;
        $("#diff").val((totalInv - poTotal).toFixed(2));
    }

    // -----------------------------
    //  Event listeners
    // -----------------------------
    $(document).on("input", "input[name^='invoice_qty_']", function () {
        // Changing qty should recalc auto-amount unless overridden
        updateInvoiceTotals();
    });

    // Initial calculation
    updateInvoiceTotals();

    // -----------------------------
    //  GRV Button logic
    // -----------------------------
    function disableGrvButtons() {
        $("button[type='submit']").prop("disabled", true);
        $("#confirm-grv-btn").prop("disabled", true);
        $("#create-debit-note-btn").prop("disabled", true);
    }

    const grvStatus = $("#grv_status_display").val().trim();
    if (grvStatus === "Completed") {
        disableGrvButtons();
    }

    // -----------------------------
    // SAVE GRV (AJAX)
    // -----------------------------
    $("#grv-form").on("submit", function (e) {
        e.preventDefault();   // <-- STOP PAGE NAVIGATION

        let formData = $(this).serialize();

        $.post("{{ url_for('main.submit_grv', po_id=po.id) }}", formData)
            .done(function (response) {
                // SweetAlert success popup
                Swal.fire({
                    icon: 'success',
                    title: 'Saved!',
                    text: response.message,
                    confirmButtonColor: '#3085d6'
                }).then(() => {
                    location.reload();  // refresh page so GRV shows saved values
                });
            })
            .fail(function (xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error Saving GRV',
                    text: xhr.responseJSON?.error || "Unexpected error"
                });
            });
    });


    // -----------------------------
    //  Confirm GRV (SweetAlert2)
    // -----------------------------
    $("#confirm-grv-btn").click(function () {

        const status = $("#grv_status_display").val().trim();

        if (status !== "Saved") {
            Swal.fire({
                icon: "warning",
                title: "Cannot Confirm GRV",
                text: "Please save the GRV before confirming."
            });
            return;
        }

        Swal.fire({
            title: "Confirm GRV?",
            text: "This action will finalize the GRV and update stock.",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Yes, confirm",
            cancelButtonText: "Cancel",
            reverseButtons: true
        }).then((result) => {

            if (!result.isConfirmed) return;

            // --- Send request ---
            $.post("{{ url_for('main.confirm_grv', po_id=po.id) }}", function (response) {

                // If backend sent cost updates → Show cost modal
                if (response.message === "cost_updates") {

                    grvConfirmedWithCostUpdates = true;

                    const list = $("#costUpdateList");
                    list.empty();

                    response.items.forEach((i) => {
                        list.append(
                            `<li class="list-group-item">
                                <strong>${i.sku}</strong> — ${i.name}<br>
                                Old: ${i.old} → New: ${i.new}
                            </li>`
                        );
                    });

                    const modal = new bootstrap.Modal(document.getElementById("costUpdateModal"));
                    modal.show();

                    $("#grv_status_display").val("Completed");
                    disableGrvButtons();
                }


                // Normal success → Show success modal
                else if (response.message === "grv_confirmed" || response.message === "GRV successfully confirmed") {

                    const modal = new bootstrap.Modal(document.getElementById("grvConfirmSuccessModal"));
                    modal.show();

                    $("#grv_status_display").val("Completed");
                    disableGrvButtons();
                }

            }).fail(function () {
                // Error modal
                const errorModal = new bootstrap.Modal(document.getElementById("grvConfirmErrorModal"));
                $("#grvErrorText").text("Failed to confirm GRV. Please try again.");
                errorModal.show();
            });

        });
    });



    // -----------------------------
    //  Create Debit Note
    // -----------------------------
    $("#create-debit-note-btn").click(function () {

        const status = $("#grv_status_display").val().trim();

        if (status !== "Saved") {
            alert("Cannot create debit note. Please save the GRV first.");
            return;
        }

        if (!confirm("Creating a debit note will confirm and close the GRV.\nDo you wish to proceed?")) return;

        $.post("{{ url_for('main.create_debit_note', po_id=po.id) }}", function (response) {
            alert(response.message);
            $("#grv_status_display").val("Completed");
            disableGrvButtons();
        }).fail(function () {
            alert("Failed to create Debit Note. Please try again.");
        });
    });


    function showErrorModal(message) {
        $("#errorModalMessage").text(message);
        new bootstrap.Modal(document.getElementById('errorModal')).show();
    }



});
</script>

<!-- Cost Price Update Modal -->
<div class="modal fade" id="costUpdateModal" tabindex="-1" aria-labelledby="costUpdateLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="costUpdateLabel">
          Cost Price Updates Detected
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p>The following items had their cost price updated based on the supplier invoice:</p>

        <ul id="costUpdateList" class="list-group">
          <!-- JS inserts updated items here -->
        </ul>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-success" id="modalOkBtn" data-bs-dismiss="modal">
          OK
        </button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="grvConfirmSuccessModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 text-center">
      <h4 class="text-success fw-bold mb-3">
        <i class="bi bi-check-circle-fill"></i> GRV Confirmed
      </h4>
      <p class="mb-3">The GRV has been confirmed and stock has been updated successfully.</p>
      <button class="btn btn-primary" data-bs-dismiss="modal">OK</button>
    </div>
  </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 text-center">
      <h4 class="text-danger fw-bold mb-3">
        <i class="bi bi-exclamation-triangle-fill"></i> Error
      </h4>
      <p id="errorModalMessage" class="mb-3"></p>
      <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    </div>
  </div>
</div>




</body>
</html>

