<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Purchase Orders</title>

  <!-- Favicons -->
  <link href="/static/assets/img/best_before.png" rel="icon">
  <link href="/static/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700|Nunito:300,400,600,700|Poppins:300,400,500,600,700" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="/static/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="/static/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="/static/assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="/static/assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="/static/assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Vendor JS Files -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/static/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/static/assets/vendor/quill/quill.min.js"></script>
<script src="/static/assets/vendor/simple-datatables/simple-datatables.js"></script>
<script src="/static/assets/js/functions.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">

  <!-- Main CSS File -->
  <link href="/static/assets/css/style.css" rel="stylesheet">
</head>

<body>


{% include 'header-bar.html' %}
{% include 'side-bar.html' %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" style="margin-left: 280px;">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<main id="main" class="main">
  <div class="pagetitle">
    <h1>Purchase Orders</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Home</a></li>
        <li class="breadcrumb-item">Orders</li>
        <li class="breadcrumb-item active">Purchase Orders</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body pt-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">PO List</h5>
              <a href="{{ url_for('main.po_create') }}" class="btn btn-primary">Create New PO</a>
            </div>

            <table id="poTable" class="table table-bordered table-striped w-100">
              <thead>
                <tr>
                  <th>PO Number</th>
                  <th>Supplier</th>
                  <th>Created On</th>
                  <th>Status</th>
                  <th>Status Date</th>
                  <th>Total</th>
                  <th># Items</th>
                  <th>Actions</th>
                </tr>
                <tr>
                  <th><input type="text" placeholder="ðŸ” Search PO"></th>
                  <th><input type="text" placeholder="ðŸ” Search Supplier"></th>
                  <th><input type="text" placeholder="ðŸ” Search Date"></th>
                  <th><input type="text" placeholder="ðŸ” Search Status"></th>
                  <th><input type="text" placeholder="ðŸ” Search Status Date"></th>
                  <th><input type="text" placeholder="ðŸ” Search Total"></th>
                  <th></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for po in pos %}
                <tr>
                  <td>{{ po.po_number }}</td>
                  <td>{{ po.supplier.name if po.supplier }}</td>
                  <td>{{ po.order_date.strftime('%d-%m-%Y') if po.order_date else '' }}</td>
                  <td>
                    <span class="badge bg-{{ status_color(po.status) }}">{{ po.status }}</span>
                  </td>
                  <td>{{ po.status_date.strftime('%Y-%m-%d %H:%M') if po.status_date else '' }}</td>
                  <td>{{ '%.2f' % (po.subtotal or 0) }}</td>
                  <td>{{ po.items|length }}</td>
                  <td>
                    <a href="{{ url_for('main.po_view', po_id=po.id) }}" class="btn btn-sm btn-primary">View</a>
                    {% if po.status == 'Approved' %}
                      <button class="btn btn-sm btn-warning update-status" data-id="{{ po.id }}" data-status="Sent"{% if po.status != 'Approved' %}disabled{% endif %}>Mark as Sent</button>
                    {% endif %}
                    <a href="{{ url_for('main.po_edit', po_id=po.id) }}" class="btn btn-sm btn-warning {% if po.status not in ['Draft', 'Submitted', 'Approved'] %}disabled{% endif %}">Edit </a>
                    <button class="btn btn-sm btn-success update-status" data-id="{{ po.id }}" data-status="Approved"  {% if po.status not in ['Draft', 'Submitted'] %}disabled{% endif %}>Approve</button>
                    <a href="{{ url_for('main.po_delete', po_id=po.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this PO?')">Delete</a>
                    {% if po.status not in ['Completed', 'Cancelled'] %}
                          <button class="btn btn-sm btn-dark update-status" data-id="{{ po.id }}" data-status="Cancelled" {% if po.status in ['Completed', 'Cancelled'] %}disabled{% endif %}>Cancel</button>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  $(document).ready(function () {
    // Only initialize if not already initialized
    if (!$.fn.DataTable.isDataTable('#poTable')) {
      const table = $('#poTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
          {
            extend: 'excelHtml5',
            text: 'Download Excel',
            title: 'PO_List_' + new Date().toISOString().slice(0, 10)
          }
        ],
        order: [[4, 'desc']],
        pageLength: 25,
        lengthMenu: [[25, 50, 100], [25, 50, 100]],
        initComplete: function () {
          this.api().columns().every(function () {
            var column = this;
            $('input', column.header()).on('keyup change clear', function () {
              if (column.search() !== this.value) {
                column.search(this.value).draw();
              }
            });
          });
        }
      });
    }

    // Status update click handler
    $(document).on('click', '.update-status', function () {
      const poId = $(this).data('id');
      const newStatus = $(this).data('status');

      if (!confirm(`Are you sure you want to set status to ${newStatus}?`)) return;

      $.ajax({
        url: `/purchase_orders/${poId}/update_status`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function (data) {
          alert(data.message);
          location.reload();
        },
        error: function () {
          alert("Status update failed.");
        }
      });
    });
  });

       //log activity
    $(".btn").on("click", function () {
        // Get the text of the clicked button
        const buttonText = $(this).text().trim();

        // Get the current file name without the ".html" postfix
        const fileName = window.location.pathname.split("/").pop().replace(".html", "");

        // Create a combined activity description
        const activityDescription = `${fileName}: ${buttonText}`;

        console.log("clicking on ",activityDescription);

        // Call the logUserActivity function with the combined description
        logUserActivity(activityDescription);
    });

</script>




</body>
</html>

