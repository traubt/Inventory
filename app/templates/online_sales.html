<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>TOC 360 — Online Sales Heat Map</title>

  <!-- Favicons -->
  <link href="static/assets/img/toc_logo.png" rel="icon">
  <link href="static/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700|Nunito:300,400,600,700|Poppins:300,400,500,600,700" rel="stylesheet">

  <!-- Vendor CSS -->
  <link href="static/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="static/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="static/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Template CSS -->
  <link href="static/assets/css/style.css" rel="stylesheet">

  <!-- DataTables + Buttons (Excel) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedHeader/3.4.0/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedHeader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>



  <style>
    #map {
      width: 100%;
      height: 520px;
      border-radius: 12px;
    }
    .filter-row .form-select, .filter-row .form-control {
      min-width: 180px;
    }
  </style>
</head>
<body>

  {% include 'header-bar.html' %}
  {% include 'side-bar.html' %}

  <main id="main" class="main">
    <div class="pagetitle">
      <h1>Online Sales Heat Map</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item">Analytics</li>
          <li class="breadcrumb-item active">Online Sales Heat Map</li>
        </ol>
      </nav>
    </div>

    <!-- Filters -->
    <section class="section">
      <div class="card">
        <div class="card-body pt-3">
          <div class="row g-3 align-items-end filter-row">
            <div class="col-auto">
              <label class="form-label mb-0">Date Range:</label>
              <select id="presetRange" class="form-select">
                <option value="" disabled selected>Select date range:</option>
                <option value="today">Today</option>
                <option value="wtd">Week to Date</option>
                <option value="mtd">Month to Date</option>
                <option value="qtd">Quarter to Date</option>
                <option value="ytd">Year to Date</option>
                <option value="custom">Custom</option>
              </select>
            </div>

            <div class="col-auto">
              <label for="fromDate" class="form-label mb-0">From</label>
              <input type="date" id="fromDate" class="form-control">
            </div>

            <div class="col-auto">
              <label for="toDate" class="form-label mb-0">To</label>
              <input type="date" id="toDate" class="form-control">
            </div>

            <div class="col-auto">
              <label for="region" class="form-label mb-0">Region (shipping_state)</label>
              <select id="region" class="form-select">
                <option value="">All Regions</option>
              </select>
            </div>

            <div class="col-auto">
              <button id="applyFilters" class="btn btn-primary">
                <i class="bi bi-filter-circle me-1"></i>Apply
              </button>
              <button id="resetFilters" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Map -->
    <section class="section">
      <div class="card">
        <div class="card-body pt-3">
          <div id="map"></div>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="section">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-2">Results</h5>
          <div class="table-responsive">
            <table class="table table-striped nowrap" id="resultsTable" style="width:100%">
              <thead>
                <tr class="filter-row"></tr> <!-- per-column search inputs will be injected here -->
                <tr>
                  <th>Order ID</th>
                  <th>Order Date</th>
                  <th>Customer</th>
                  <th>Total</th>
                  <th>City</th>
                  <th>State</th>
                  <th>Lat</th>
                  <th>Lng</th>
                </tr>
              </thead>
              <tbody></tbody>
  <tfoot>
    <tr>
      <th></th> <!-- Order ID footer will show count -->
      <th></th>
      <th></th>
      <th></th> <!-- Total footer will show sum -->
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </tfoot>
            </table>
          </div>
          <div class="small text-muted mt-2" id="summaryText"></div>
        </div>
      </div>
    </section>


  </main>

  <!-- Vendor JS -->
  <script src="static/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="static/assets/vendor/simple-datatables/simple-datatables.js"></script>

  <!-- Google Maps (Visualization library for Heatmap) -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=visualization&callback=initMap">
  </script>

 <script>
  // ---------- Utilities ----------
  const fmtDate = d => d.toISOString().slice(0,10);

  function setPreset(preset) {
    const today = new Date();
    const y = today.getFullYear(), m = today.getMonth(), d = today.getDate();
    let from, to;
    if (preset === 'today') { from = new Date(y,m,d); to = new Date(y,m,d); }
    else if (preset === 'wtd') { const dow = today.getDay(); from = new Date(y,m,d - (dow===0?6:(dow-1))); to = new Date(y,m,d); }
    else if (preset === 'qtd') { const qStart = Math.floor(m/3)*3; from = new Date(y,qStart,1); to = new Date(y,m,d); }
    else if (preset === 'ytd') { from = new Date(y,0,1); to = new Date(y,m,d); }
    else { from = new Date(y,m,1); to = new Date(y,m,d); } // mtd default
    $('#fromDate').val(fmtDate(from)); $('#toDate').val(fmtDate(to));
  }

  // ---------- Map ----------
  let map, heatmap;

  // ---------- DataTable ----------
  let dt;
  function formatDateTime(s) {
    if (!s) return '';
    const d = new Date(s.replace(' ', 'T'));
    if (isNaN(d.getTime())) return s;
    return d.toLocaleString('en-ZA', {
      year: 'numeric',
      month: 'short',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    }).replace(',', '');
  }

  const dtColumns = [
    { title:'Order ID',   data:'order_id' },
    { title:'Order Date', data:'order_date', render:(v)=> formatDateTime(v) },
    { title:'Customer',   data:'customer_name' },
    { title:'Total',      data:'total_amount', render: (v)=> Number(v||0).toFixed(2) },
    { title:'City',       data:'shipping_city' },
    { title:'State',      data:'shipping_state' },
    { title:'Lat',        data:'shipping_latitude' },
    { title:'Lng',        data:'shipping_longitude' }
  ];

  function buildFilterRow() {
    const $row = $('#resultsTable thead tr.filter-row').empty();
    dtColumns.forEach(col => {
      $row.append(
        `<th><input class="form-control form-control-sm" type="text" placeholder="🔍 ${col.title}" /></th>`
      );
    });
  }

  function initDataTable(rows, exportTitle) {
    buildFilterRow();

    if (dt) {
      dt.clear().rows.add(rows).draw();
    } else {
      dt = new $.fn.dataTable.Api($('#resultsTable').DataTable({
        data: rows,
        columns: dtColumns,
        order: [[1, 'desc']],
        paging: false,        // no pagination
        info: true,
        searching: true,
        scrollY: 38*25,       // ≈ 50 rows tall
        scrollCollapse: true,
        fixedHeader: true,
        dom: 'Bt',            // buttons only (no global search box!)
        buttons: [
          {
            extend: 'excelHtml5',
            text: 'Download To Excel',
            title: exportTitle
          }
        ],
        initComplete: function () {
          const api = this.api();
          api.columns().every(function (i) {
            const that = this;
            $('thead tr.filter-row th:eq('+i+') input')
              .on('keyup change', function () {
                if (that.search() !== this.value) { that.search(this.value).draw(); }
              });
          });
        },
        footerCallback: function (row, data) {
          // Data after filters
          const api = this.api();
          const filteredData = api.rows({ filter: 'applied' }).data().toArray();

          // Count of orders
          const count = filteredData.length;

          // Sum of totals
          const sum = filteredData.reduce((s, r) => s + (parseFloat(r.total_amount) || 0), 0);

          // Write into footer
          $(api.column(0).footer()).html(`<strong>${count} orders</strong>`); // Order ID column footer
          $(api.column(3).footer()).html(`<strong>ZAR ${sum.toFixed(2)}</strong>`); // Total column footer

          // Update summary text (optional, below table)
          $('#summaryText').text(`${count} orders • Total ZAR ${sum.toFixed(2)}`);
        }

      }));
    }

    dt.on('draw.dt', function () {
      const data = dt.rows({ filter: 'applied'}).data().toArray();
      const sum = data.reduce((s, r) => s + (parseFloat(r.total_amount)||0), 0);
      $('#totalSum').text('ZAR ' + sum.toFixed(2));
      $('#summaryText').text(`${data.length} orders • Total ZAR ${sum.toFixed(2)}`);
    });
  }

  // ---------- Data fetchers ----------
  function fetchRegions() {
    $.getJSON("{{ url_for('main.api_online_sales_regions') }}", (rows) => {
      const $sel = $('#region').empty().append('<option value="">All Regions</option>');
      rows.forEach(r => $sel.append(`<option value="${r.shipping_state}">${r.shipping_state}</option>`));
    });
  }

  function loadData() {
    const from = $('#fromDate').val();
    const to   = $('#toDate').val();
    const region = $('#region').val() || '';
    const url = "{{ url_for('main.api_online_sales_heatmap') }}" +
                `?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&region=${encodeURIComponent(region)}`;

    $.getJSON(url, (rows) => {
      const points = rows
        .filter(r => r.shipping_latitude !== null && r.shipping_longitude !== null)
        .map(r => ({
          location: new google.maps.LatLng(parseFloat(r.shipping_latitude), parseFloat(r.shipping_longitude)),
          weight: Math.max(1, parseFloat(r.total_amount) || 1)
        }));
      heatmap.setData(points);

      if (points.length) {
        const bounds = new google.maps.LatLngBounds();
        points.forEach(p => bounds.extend(p.location));
        map.fitBounds(bounds);
      } else {
        map.setCenter({ lat: -28.4793, lng: 24.6727 }); map.setZoom(5);
      }

      const exportTitle = `Online_Sales_${from}_to_${to}${region?('_'+region):''}`;
      initDataTable(rows, exportTitle);
    });
  }

  // ---------- Events ----------
  $('#presetRange').on('change', function () { setPreset(this.value); });
  $('#applyFilters').on('click', function () { loadData(); });
  $('#resetFilters').on('click', function () {
    $('#presetRange').val('mtd'); setPreset('mtd'); $('#region').val(''); loadData();
  });

      //log activity
    $(".btn").on("click", function () {
        // Get the text of the clicked button
        const buttonText = $(this).text().trim();

        // Get the current file name without the ".html" postfix
        const fileName = window.location.pathname.split("/").pop().replace(".html", "");

        // Create a combined activity description
        const activityDescription = `${fileName}: ${buttonText}`;

        // Call the logUserActivity function with the combined description
        logUserActivity(activityDescription);
    });

  // ---------- Map Boot ----------
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: -28.4793, lng: 24.6727 }, zoom: 5,
      mapTypeControl: false, streetViewControl: false
    });
    heatmap = new google.maps.visualization.HeatmapLayer({ data: [], dissipating: true, radius: 30 });
    heatmap.setMap(map);

    setPreset('mtd'); $('#presetRange').val('mtd');
    fetchRegions();
    loadData();
  }
  window.initMap = initMap;
</script>


</body>
</html>
