<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>TOC - admin</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="static/assets/img/toc_logo.png" rel="icon">
  <link href="static/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

<!--  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script>


  <!-- Vendor CSS Files -->
  <link href="static/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="static/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="static/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="static/assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="static/assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="static/assets/vendor/remixicon/remixicon.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="static/assets/css/style.css" rel="stylesheet">

  <script src="static/assets/js/functions.js"></script>

<!--    Datatables-->
<!--    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">-->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>

      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Bootstrap Datepicker CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.2.2/css/fixedHeader.dataTables.min.css">

    <style>
        /* Set a max height and allow vertical scrolling */
        .dataTables_wrapper {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>




  <!-- =======================================================
  * Template Name: NiceAdmin
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Updated: Apr 20 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

   {% include 'header-bar.html' %}

   {% include 'side-bar.html' %}

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Reports</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item">Pages</li>
          <li class="breadcrumb-item active">Sales Report</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section">
      <div class="row">
        <div class="col-lg-12">

              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Sales Report</h5>
                  </div>
                          <!-- List of Sales Reports with Radio Buttons -->
                  <div class="mt-4">
                    <h6 class="mb-3">Select a Report:</h6>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="shopReport" value="Sales Report Per Shop" checked>
                      <label class="form-check-label" for="shopReport">Sales Report Per Shop</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="staffReport" value="Sales Report Per Staff">
                      <label class="form-check-label" for="staffReport">Sales Report Per Staff</label>
                    </div>
                  <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="staffCategory" value="Product Category Per Staff">
                      <label class="form-check-label" for="staffCategory">Product Category Per Staff</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="productReport" value="Product Sales Report">
                      <label class="form-check-label" for="productReport">Product Sales Report</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="brandReport" value="Brand Sales Report">
                      <label class="form-check-label" for="brandReport">Brands Sales Report</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="categoryReport" value="Product Category Sales Report">
                      <label class="form-check-label" for="categoryReport">Product Category Sales Report</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="customerReport" value="Customer Sales Report">
                      <label class="form-check-label" for="customerReport">Customer Sales Report</label>
                    </div>
<!--                   <div class="form-check">-->
<!--                      <input class="form-check-input" type="radio" name="salesReport" id="detailShopStockReport" value="Detailed Shop Stock Report">-->
<!--                      <label class="form-check-label" for="detailShopStockReport">Detailed Shop Stock Report</label>-->
<!--                    </div>-->
<!--                 <div class="form-check">-->
<!--                      <input class="form-check-input" type="radio" name="salesReport" id="ConsolidateShopStockReport" value="Consolidated Shop Stock Report">-->
<!--                      <label class="form-check-label" for="ConsolidateShopStockReport">Consolidated Shop Stock Report</label>-->
<!--                    </div>-->
                  </div>
                 <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="TransactionsReport" value="Transactions Report">
                      <label class="form-check-label" for="TransactionsReport">Transactions Report</label>
                    </div>
               <div class="form-check">
                      <input class="form-check-input" type="radio" name="salesReport" id="OnlineTransactionsReport" value="Online Transactions Report">
                      <label class="form-check-label" for="OnlineTransactionsReport">Online Transactions Report</label>
                </div>


                  <hr>

        <!-- Group By and Date Filters -->
<!--        <div class="row g-3">-->
            <!-- Group By -->
            <div class="col-md-2">
                <label for="groupBy" class="form-label">Group By</label>
                <select id="groupBy" class="form-select">
                    <option value="none">Don't Group</option>
                    <option value="day">Day</option>
                    <option value="month">Month</option>
                </select>
            </div>

            <!-- Search Between Dates -->
            <br>

            <div class="col-md-3">
                <label class="form-label">Search Between Dates</label>
                <div class="row g-2">
                    <div class="col">
                        <div class="input-group">
                            <span class="input-group-text">From</span>
                            <input type="text" id="fromDate" class="form-control datepicker" readonly>
                            <span class="input-group-text">
                                <i class="bi bi-calendar"></i>
                            </span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group">
                            <span class="input-group-text">To</span>
                            <input type="text" id="toDate" class="form-control datepicker" readonly>
                            <span class="input-group-text">
                                <i class="bi bi-calendar"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
<!--        </div>-->

                  <hr>

                  <div class="d-flex gap-1 mt-3">
                    <button class="btn btn-primary" id="runReport" >Run Report</button>
                  </div>

                  <!-- Table for Sales Report -->
                  <table id="sales_report" border="1" class="mt-4 table table-bordered table-striped w-100" >
                    <thead></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

        </div>
      </div>
    </section>
  </main><!-- End #main -->


    <script src="https://bootstrapmade.com/demo/NiceAdmin/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>NiceAdmin</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
      <!-- All the links in the footer should remain intact. -->
      <!-- You can delete the links only if you purchased the pro version. -->
      <!-- Licensing information: https://bootstrapmade.com/license/ -->
      <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
      Designed by <a href="http://algo-tt.co.za/">algo-tt</a>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="static/assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="static/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="static/assets/vendor/chart.js/chart.umd.js"></script>
  <script src="static/assets/vendor/echarts/echarts.min.js"></script>
  <script src="static/assets/vendor/quill/quill.js"></script>
  <script src="static/assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="static/assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="static/assets/js/main.js"></script>

    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<script>
$(document).ready(function () {
    // Initialize datepickers
    $('.datepicker').datepicker({
        format: 'yyyy-mm-dd', // Use ISO format for consistency
        autoclose: true,
        todayHighlight: true
    });

    // Set default dates
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    const lastMonth = new Date(today);
    lastMonth.setMonth(today.getMonth() - 1);

    $('#fromDate').datepicker('update', formatDate(lastMonth));
    $('#toDate').datepicker('update', formatDate(tomorrow));

    // Helper function to format date as yyyy-mm-dd
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    $("#runReport").on("click", function () {
        const reportType = $("input[name='salesReport']:checked").val(); // Get selected report
        const groupBy = $("#groupBy").val(); // Get group by value
        const fromDate = $("#fromDate").val(); // Get from date
        const toDate = $("#toDate").val(); // Get to date

        // Ensure all required fields are filled
        if (!reportType || !fromDate || !toDate) {
            alert("Please select a report type and specify the date range.");
            return;
        }

        // add spinner while fetching data
        const spinnerWrapper = $(`
            <div class="spinner-wrapper">
                <div class="spinner"></div>
                <p class="spinner-text">Please wait while fetching data from the server...</p>
            </div>
        `);
        $("body").append(spinnerWrapper);

        // Make AJAX request with parameters
        $.ajax({
            url: "/get_business_report",
            method: "GET",
            data: {
                reportType: reportType,
                groupBy: groupBy,
                fromDate: fromDate,
                toDate: toDate
            },
            success: function (response) {
                if (response.columns && response.data) {
                    // Step 1: Clear and destroy the existing DataTable (if any)
                    if ($.fn.DataTable.isDataTable('#sales_report')) {
                        $('#sales_report').DataTable().clear().destroy();
                    }

                    // Step 2: Dynamically rebuild the table headers
                    const table = $('#sales_report');
                    table.empty(); // Remove all existing content

                    // Create thead and tbody structure
                    const thead = $('<thead></thead>');
                    const headerRow = $('<tr></tr>');
                    response.columns.forEach(col => {
                        headerRow.append(`<th>${col.title}</th>`);
                    });
                    thead.append(headerRow);
                    table.append(thead);
                    table.append('<tbody></tbody>'); // Ensure tbody exists

                    // Step 3: Initialize DataTable with new columns and data
                    table.DataTable({
                        data: response.data,
                        columns: response.columns.map(col => ({
                            title: col.title,
                            data: col.title
                        })),
                        dom: 'Bfrtip', // Export buttons
                        buttons: [
                            {
                                extend: 'excel',
                                text: 'Download To Excel',
                                title: `${reportType}_${new Date().toISOString().slice(0, 10)}`
                            }
                        ],
                        //order: [[1, 'asc']], // Sort by second column (if applicable)
                        fixedHeader: true,
                        pageLength: 50, // Show 50 rows by default
                        lengthMenu: [
                            [50, 100, 150, 200],
                            [50, 100, 150, 200]
                        ]
                    });
                } else {
                    alert("No data available for the selected parameters.");
                }
            },
            error: function (xhr, status, error) {
                console.error("Error fetching data: ", error);
                alert("An error occurred while fetching the sales report.");
            },
            complete: function () {
            // Hide spinner after request completes
            spinnerWrapper.remove();
        }
        });
    });



});


    $('input[name="salesReport"]').on('click', function() {
      const selectedReport = $(this).val();
      //alert(`View ${selectedReport}`);
    });

    // limit transactions report to one month
    function validateDateRange() {
        if ($('#TransactionsReport').is(':checked')) {
            const fromDate = $('#fromDate').val();
            const toDate = $('#toDate').val();

            if (fromDate && toDate) {
                const from = new Date(fromDate);
                const to = new Date(toDate);
                const diffDays = (to - from) / (1000 * 60 * 60 * 24); // Convert milliseconds to days

                if (diffDays > 33) {
                    alert("System can't fetch data for more than one month. Please change the date range.");
                    $('#toDate').val(''); // Clear the toDate input
                    return;
                }
            }
        }
    }

    // Trigger validation when TransactionsReport is selected
    $('input[name="salesReport"]').change(validateDateRange);

    // Trigger validation when fromDate or toDate changes
    $('#fromDate, #toDate').change(validateDateRange);

</script>



</body>

</html>