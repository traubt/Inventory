<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>TOC - 360 Tables</title>

  <link href="static/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="static/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="static/assets/css/style.css" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
</head>
<body>

{% include 'header-bar.html' %}
{% include 'side-bar.html' %}

<main id="main" class="main">

  <div class="pagetitle">
    <h1>Inventory Reports</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Home</a></li>
        <li class="breadcrumb-item">Inventory</li>
        <li class="breadcrumb-item active">360 Tables</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">360 Tables</h5>

        <form id="systemTablesForm" class="row g-3">
          <!-- Tables dropdown -->
          <div class="col-md-4">
            <label for="tableName" class="form-label">360 Tables</label>
            <select id="tableName" name="tableName" class="form-select">
              <option value="">-- select table --</option>
              {% for t in toc_tables %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Shows tables where name like <code>toc%</code>.</div>
          </div>

          <div class="col-md-2">
            <label for="rowLimit" class="form-label">Row limit</label>
            <input id="rowLimit" class="form-control" type="number" min="1" step="1" value="5000">
          </div>

          <div class="col-12">
            <button type="button" id="runReport" class="btn btn-primary mt-2">Run Report</button>
          </div>
        </form>

        <table id="system_tables_grid" class="table table-bordered table-striped w-100 mt-4">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

</main>

<script>
$(function () {
  $("#runReport").on("click", function () {
    const tableName = $("#tableName").val();
    const rowLimit = $("#rowLimit").val() || 5000;

    if (!tableName) {
      alert("Please select a table.");
      return;
    }

    $.ajax({
      url: "/api/system_table_data",
      method: "GET",
      data: { table: tableName, limit: rowLimit },
      success: function (response) {
        if (!response || !response.columns) {
          alert("No data returned.");
          return;
        }

        // Destroy existing grid if any
        if ($.fn.DataTable.isDataTable("#system_tables_grid")) {
          $("#system_tables_grid").DataTable().clear().destroy();
          $("#system_tables_grid thead").empty();
        }

        // Build columns config
        const columns = response.columns.map(c => ({ title: c, data: c }));

        $("#system_tables_grid").DataTable({
          data: response.data,
          columns: columns,
          dom: "Bfrtip",
          buttons: [{ extend: "excel", text: "Download Excel" }],
          pageLength: 50,
          lengthMenu: [[50, 100, 200], [50, 100, 200]],
          fixedHeader: true,
          deferRender: true
        });
      },
      error: function (xhr) {
        const msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : "Error fetching data.";
        alert(msg);
      }
    });
  });
});
</script>

</body>
</html>
